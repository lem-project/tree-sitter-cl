name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Build C libraries
        run: |
          nix build .#ts-wrapper
          nix build .#tree-sitter-json-grammar

      - name: Setup SBCL and Quicklisp
        run: |
          nix profile install nixpkgs#sbcl
          curl -sO https://beta.quicklisp.org/quicklisp.lisp
          sbcl --non-interactive \
               --load quicklisp.lisp \
               --eval '(quicklisp-quickstart:install)'

          # Add Quicklisp to init file manually (avoid interactive prompt)
          cat >> ~/.sbclrc << 'INITEOF'
          #-quicklisp
          (let ((quicklisp-init (merge-pathnames "quicklisp/setup.lisp" (user-homedir-pathname))))
            (when (probe-file quicklisp-init)
              (load quicklisp-init)))
          INITEOF

      - name: Run tests
        run: |
          TREE_SITTER_LIB=$(nix eval --raw nixpkgs#tree-sitter)/lib
          TS_WRAPPER_LIB=$(nix build .#ts-wrapper --print-out-paths)/lib
          JSON_GRAMMAR_LIB=$(nix build .#tree-sitter-json-grammar --print-out-paths)/lib
          export LD_LIBRARY_PATH="$TREE_SITTER_LIB:$TS_WRAPPER_LIB:$JSON_GRAMMAR_LIB"
          export CL_SOURCE_REGISTRY="$PWD//"

          sbcl --non-interactive \
               --eval '(format t "ASDF version: ~a~%" (asdf:asdf-version))' \
               --eval '(ql:quickload :rove)' \
               --eval '(ql:quickload (list :cffi :alexandria :trivial-garbage :babel))' \
               --eval '(asdf:clear-source-registry)' \
               --eval '(asdf:initialize-source-registry)' \
               --eval '(ql:quickload :tree-sitter-cl/tests)' \
               --eval '(let ((result (rove:run :tree-sitter-cl/tests))) (unless result (uiop:quit 1)))'

  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup SBCL and Quicklisp
        run: |
          nix profile install nixpkgs#sbcl
          curl -sO https://beta.quicklisp.org/quicklisp.lisp
          sbcl --non-interactive \
               --load quicklisp.lisp \
               --eval '(quicklisp-quickstart:install)'

          # Add Quicklisp to init file manually (avoid interactive prompt)
          cat >> ~/.sbclrc << 'INITEOF'
          #-quicklisp
          (let ((quicklisp-init (merge-pathnames "quicklisp/setup.lisp" (user-homedir-pathname))))
            (when (probe-file quicklisp-init)
              (load quicklisp-init)))
          INITEOF

      - name: Build and run mallet
        run: |
          # Get mallet source and copy to writable directory
          MALLET_SRC_NIX=$(nix build .#mallet-src --print-out-paths)
          TRIVIAL_GLOB_SRC=$(nix build .#trivial-glob --print-out-paths)

          MALLET_SRC="$HOME/mallet"
          cp -r "$MALLET_SRC_NIX" "$MALLET_SRC"
          chmod -R u+w "$MALLET_SRC"

          export CL_SOURCE_REGISTRY="$TRIVIAL_GLOB_SRC//:$MALLET_SRC//"

          # Build mallet
          cd "$MALLET_SRC"
          sbcl --noinform --non-interactive \
               --eval '(ql:quickload :alexandria)' \
               --eval '(ql:quickload :cl-ppcre)' \
               --eval '(ql:quickload :eclector)' \
               --eval '(asdf:load-system :mallet)' \
               --eval '(asdf:make :mallet)'

          # Run mallet on project
          cd "$GITHUB_WORKSPACE"
          "$MALLET_SRC/mallet" src/ *.asd
